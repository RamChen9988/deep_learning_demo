import numpy as np

# ==================== æåº¦ç®€åŒ–çš„RNNæ¼”ç¤º ====================
# ç›®æ ‡ï¼šç†è§£RNNçš„æ ¸å¿ƒæ€æƒ³ - "è®°å¿†ä¼ é€’"
# åœºæ™¯ï¼šæ¨¡æ‹Ÿä¸€ä¸ªç®€å•çš„è¯­è¨€æ¨¡å‹ï¼Œé¢„æµ‹å¥å­ä¸­ä¸‹ä¸€ä¸ªè¯çš„ç±»å‹
# ==================== æ³¨é‡Šè¶³å¤Ÿè¯¦ç»†ï¼Œè¯·é€è¡Œé˜…è¯» ====================

def simple_rnn_demo():
    """
    æ¼”ç¤ºRNNå¦‚ä½•å¤„ç†åºåˆ—æ•°æ®ï¼š['æˆ‘', 'çˆ±', 'å­¦ä¹ ']
    è¯æ€§ç¼–ç : åè¯=0, åŠ¨è¯=1, å­¦ä¹ =2(ç‰¹æ®Šåè¯)
    """
    
    # ========== 1. æ¨¡æ‹Ÿæ•°æ®å‡†å¤‡ ==========
    print("=== 1. æ•°æ®å‡†å¤‡ ===")
    
    # è¾“å…¥åºåˆ—ï¼š['æˆ‘', 'çˆ±', 'å­¦ä¹ '] çš„è¯æ€§ç¼–ç 
    # æ³¨æ„ï¼šè¿™æ˜¯ç®€åŒ–è¡¨ç¤ºï¼Œå®é™…ä¸­ä¼šç”¨è¯å‘é‡
    X_sequence = [
        [1, 0, 0],  # 'æˆ‘' - åè¯ (one-hot)
        [0, 1, 0],  # 'çˆ±' - åŠ¨è¯  
        [0, 0, 1]   # 'å­¦ä¹ ' - å­¦ä¹  (ç‰¹æ®Šåè¯)
    ]
    
    print(f"è¾“å…¥åºåˆ—å½¢çŠ¶: {len(X_sequence)}ä¸ªæ—¶é—´æ­¥, æ¯ä¸ªæ—¶é—´æ­¥{len(X_sequence[0])}ç»´")
    print(f"åºåˆ—å†…å®¹: åè¯(æˆ‘) -> åŠ¨è¯(çˆ±) -> åè¯(å­¦ä¹ )")
    
    # ========== 2. åˆå§‹åŒ–å‚æ•° ==========
    print("\n=== 2. åˆå§‹åŒ–RNNå‚æ•° ===")
    
    # è®¾ç½®éšæœºç§å­ï¼Œä¿è¯æ¯æ¬¡è¿è¡Œç»“æœä¸€è‡´
    np.random.seed(42)
    
    # ç½‘ç»œç»´åº¦
    input_dim = 3   # è¾“å…¥ç»´åº¦ (è¯è¡¨å¤§å°)
    hidden_dim = 4  # éšè—å±‚ç»´åº¦ (è®°å¿†å®¹é‡)
    output_dim = 3  # è¾“å‡ºç»´åº¦ (é¢„æµ‹ä¸‹ä¸€ä¸ªè¯çš„è¯æ€§)
    
    # æƒé‡çŸ©é˜µ (ç”¨å°æ•°ä¾¿äºç†è§£)
    # W_xh: è¾“å…¥åˆ°éšè—å±‚çš„æƒé‡ (3Ã—4)
    W_xh = np.array([
        [0.1, 0.2, 0.3, 0.4],  # åè¯è¾“å…¥çš„æƒé‡
        [0.5, 0.6, 0.7, 0.8],  # åŠ¨è¯è¾“å…¥çš„æƒé‡  
        [0.9, 1.0, 1.1, 1.2]   # å­¦ä¹ è¾“å…¥çš„æƒé‡
    ])
    
    # W_hh: éšè—å±‚åˆ°éšè—å±‚çš„æƒé‡ (4Ã—4) - è¿™æ˜¯RNNçš„"è®°å¿†"æ ¸å¿ƒ!
    W_hh = np.array([
        [0.1, 0.1, 0.1, 0.1],
        [0.2, 0.2, 0.2, 0.2], 
        [0.3, 0.3, 0.3, 0.3],
        [0.4, 0.4, 0.4, 0.4]
    ])
    
    # W_hy: éšè—å±‚åˆ°è¾“å‡ºå±‚çš„æƒé‡ (4Ã—3)
    W_hy = np.array([
        [0.1, 0.2, 0.3],
        [0.4, 0.5, 0.6],
        [0.7, 0.8, 0.9],
        [1.0, 1.1, 1.2]
    ])
    
    # åç½®é¡¹
    b_h = np.array([0.1, 0.1, 0.1, 0.1])  # éšè—å±‚åç½® (4,)
    b_y = np.array([0.1, 0.1, 0.1])       # è¾“å‡ºå±‚åç½® (3,)
    
    print(f"W_xhå½¢çŠ¶: {W_xh.shape} (è¾“å…¥â†’éšè—)")
    print(f"W_hhå½¢çŠ¶: {W_hh.shape} (éšè—â†’éšè—) â† è¿™æ˜¯è®°å¿†ä¼ é€’çš„å…³é”®!")
    print(f"W_hyå½¢çŠ¶: {W_hy.shape} (éšè—â†’è¾“å‡º)")
    
    # ========== 3. RNNå‰å‘ä¼ æ’­ ==========
    print("\n=== 3. RNNå‰å‘ä¼ æ’­è¿‡ç¨‹ ===")
    
    # åˆå§‹åŒ–éšè—çŠ¶æ€ (å…¨é›¶) - è¿™æ˜¯RNNçš„"åˆå§‹è®°å¿†"
    h_prev = np.zeros(hidden_dim)
    print(f"åˆå§‹éšè—çŠ¶æ€: {h_prev} (è¿˜æ²¡æœ‰ä»»ä½•è®°å¿†)")
    
    # å­˜å‚¨æ¯ä¸ªæ—¶é—´æ­¥çš„ç»“æœ
    outputs = []
    hidden_states = [h_prev]
    
    # å¾ªç¯å¤„ç†åºåˆ—ä¸­çš„æ¯ä¸ªè¯
    for t, x_t in enumerate(X_sequence):
        print(f"\n--- æ—¶é—´æ­¥ {t+1}: å¤„ç† '{['æˆ‘', 'çˆ±', 'å­¦ä¹ '][t]}' ---")
        
        # å½“å‰è¾“å…¥ (è½¬æ¢ä¸ºåˆ—å‘é‡ä¾¿äºç†è§£)
        x_t = np.array(x_t)
        print(f"å½“å‰è¾“å…¥ x{t}: {x_t}")
        print(f"å‰ä¸€ä¸ªéšè—çŠ¶æ€ h{t-1}: {h_prev}")
        
        # ===== RNNæ ¸å¿ƒè®¡ç®— =====
        # h_t = tanh(W_xh * x_t + W_hh * h_prev + b_h)
        # æ–°è®°å¿† = æ¿€æ´»å‡½æ•°(å½“å‰è¾“å…¥çš„å½±å“ + å†å²è®°å¿†çš„å½±å“ + åç½®)
        
        # è®¡ç®—å½“å‰æ—¶é—´æ­¥çš„éšè—çŠ¶æ€
        h_t = np.tanh(np.dot(W_xh.T, x_t) + np.dot(W_hh.T, h_prev) + b_h)
        print(f"æ–°éšè—çŠ¶æ€ h{t}: {h_t} (åŒ…å«äº†å½“å‰è¯+å†å²è®°å¿†çš„ä¿¡æ¯)")
        
        # è®¡ç®—è¾“å‡º
        y_t = np.dot(W_hy.T, h_t) + b_y
        print(f"è¾“å‡º logits y{t}: {y_t}")
        
        # åº”ç”¨softmaxå¾—åˆ°æ¦‚ç‡åˆ†å¸ƒ
        probs = np.exp(y_t) / np.sum(np.exp(y_t))
        print(f"é¢„æµ‹æ¦‚ç‡: åè¯={probs[0]:.3f}, åŠ¨è¯={probs[1]:.3f}, å­¦ä¹ ={probs[2]:.3f}")
        
        # é¢„æµ‹ç»“æœ (å–æ¦‚ç‡æœ€å¤§çš„)
        prediction = np.argmax(probs)
        predicted_label = ['åè¯', 'åŠ¨è¯', 'å­¦ä¹ '][prediction]
        print(f"é¢„æµ‹ä¸‹ä¸€ä¸ªè¯æ€§: {predicted_label}")
        
        # ä¿å­˜ç»“æœï¼Œæ›´æ–°éšè—çŠ¶æ€
        outputs.append((probs, predicted_label))
        hidden_states.append(h_t)
        h_prev = h_t  # å…³é”®ï¼šå°†å½“å‰éšè—çŠ¶æ€ä¼ é€’ç»™ä¸‹ä¸€ä¸ªæ—¶é—´æ­¥
    
    # ========== 4. ç»“æœåˆ†æ ==========
    print("\n=== 4. RNNè®°å¿†ä¼ é€’åˆ†æ ===")
    print("éšè—çŠ¶æ€çš„å˜åŒ–è¿‡ç¨‹:")
    for i, h in enumerate(hidden_states):
        print(f"h{i-1}: {h}")
    
    print("\nåºåˆ—é¢„æµ‹ç»“æœ:")
    for i, (probs, pred) in enumerate(outputs):
        current_word = ['æˆ‘', 'çˆ±', 'å­¦ä¹ '][i]
        print(f"è¾“å…¥ '{current_word}' â†’ é¢„æµ‹ä¸‹ä¸€ä¸ªè¯æ€§: {pred}")
    
    print("\nâœ… æ¼”ç¤ºå®Œæˆ! å…³é”®è§‚å¯Ÿ:")
    print("1. éšè—çŠ¶æ€ h åœ¨æ¯ä¸ªæ—¶é—´æ­¥éƒ½åœ¨æ›´æ–°")
    print("2. h åŒ…å«äº†ä¹‹å‰æ‰€æœ‰è¯çš„ä¿¡æ¯ (è®°å¿†ç´¯ç§¯)")
    print("3. é¢„æµ‹ç»“æœåŸºäºå½“å‰çš„è®°å¿† h")

# ==================== è¿è¡Œæ¼”ç¤º ====================
if __name__ == "__main__":
    print("ğŸ§  RNNå‰å‘ä¼ æ’­æ¼”ç¤º - ç†è§£'è®°å¿†ä¼ é€’'æ¦‚å¿µ")
    print("=" * 50)
    simple_rnn_demo()